# Архитектура для 1200 email-адресов (аутрич)

## 1) Описание архитектуры
Предлагается **multi-tenant архитектура**: один централизованный оркестратор кампаний + пул из 1200 почтовых ящиков, распределенных по клиентам и направлениям. Каждый клиент изолируется на уровне доменов/поддоменов, sender-пулов и репутационных лимитов.

Базовые блоки:
- **Control Plane**: планирование кампаний, очереди, лимиты, правила ротации, аудит.
- **Delivery Plane**: SMTP-провайдер(ы) и/или собственные SMTP-ноды для отправки.
- **Data Plane**: хранилище лидов, статусов писем, bounce-событий, ответов.
- **Observability Plane**: мониторинг доставляемости, blacklists, SLO/SLA, алерты.

## 2) Сервисы и подходы
- Оркестратор: Python/FastAPI + Celery/RQ для задач отправки.
- Очередь: Redis (минимальная стоимость) или RabbitMQ (если нужна более строгая маршрутизация).
- БД: PostgreSQL (клиенты, кампании, расписание, метрики).
- События доставляемости: webhook ingestion сервис.
- Почтовая отправка: гибрид — Amazon SES / Mailgun / Postmark + резервный провайдер (failover).
- DNS/аутентификация: SPF, DKIM, DMARC, отдельные tracking-домены, автоматическая проверка конфигурации.

## 3) Ротация и мониторинг
- **Ротация ящиков**: round-robin с весами по текущему health-score (bounce rate, reply rate, spam complaints).
- **Прогрев**: постепенное увеличение дневного лимита (например, +10–20% каждые 3–4 дня).
- **Ограничения**:
  - per-mailbox/day;
  - per-domain/hour;
  - per-customer/campaign.
- **Мониторинг**:
  - bounce/complaint/reject в real-time;
  - листинги blocklist;
  - задержка очереди;
  - успешность webhook-потока;
  - deliverability dashboard по клиентам.

## 4) Распределение нагрузки
- Каждая кампания разбивается на батчи (например, по 50–200 писем).
- Планировщик учитывает часовой пояс, рабочие окна и лимиты домена/ящика.
- Нагрузка распределяется по пулам отправителей; у «здоровых» ящиков вес выше.
- При деградации метрик ящик автоматически переводится в quarantine и заменяется резервом.

## 5) Риски и как закрывать
- **Высокий bounce** → обязательная валидация email до отправки, suppression list.
- **Жалобы на спам** → ограничение частоты, персонализация, обязательный unsubscribe.
- **Блокировка домена** → разнесение на поддомены и провайдеры, автопереключение маршрута.
- **Сбой провайдера** → active-standby между 2+ провайдерами.
- **Утечка данных** → шифрование at-rest/in-transit, RBAC, аудит действий.

## 6) Примерная стоимость (минимальный production)
- 1–2 VPS (оркестратор + воркер + мониторинг): ~20–60 USD/мес.
- Managed PostgreSQL/Redis (базовый tier): ~30–80 USD/мес.
- Почтовые провайдеры: зависит от объема, стартово ~50–300 USD/мес.
- Домены/поддомены/почтовые ящики: ~20–150 USD/мес.
- Итого ориентир: **120–590 USD/мес** на стартовую систему с отказоустойчивостью уровня SMB.
